# EventMamba-FX Project Memory

## Project Overview
EventMamba-FX is a Feature-Augmented Mamba model for real-time event denoising and artifact removal from event camera streams. 

## Environment Setup ğŸ”§ CRITICAL
- **MUST USE**: `source /home/lanpoknlanpokn/miniconda3/bin/activate event_flare`
- Environment already has all dependencies: PyTorch, Mamba SSM, etc.
- Python 3.10.18 with CUDA support

## ğŸš€ CURRENT SYSTEM STATUS: UNIFIED DUAL-MODE TBPTT ARCHITECTURE (2025-08-08)

### âœ… å®Œæˆçš„é‡å¤§æ¶æ„é‡æ„
EventMamba-FXå·²ä»ä¼ ç»Ÿepoch-iterationæ¶æ„æˆåŠŸé‡æ„ä¸º**å·¥ä¸šçº§åŒæ¨¡å¼TBPTTæ¶æ„**ï¼Œå®ç°äº†"é•¿åºåˆ—å·¥å‚ + åºåˆ—æ¶ˆåŒ–å™¨"è®¾è®¡æ¨¡å¼ã€‚

### ğŸ¯ åŒæ¨¡å¼è®¾è®¡æ ¸å¿ƒ

#### æ¨¡å¼ä¸€ï¼šå®æ—¶ç”Ÿæˆä¸å­˜æ¡£ (Generate-and-Train)
- **æµç¨‹**: DataLoaderæ¯æ¬¡è°ƒç”¨å®æ—¶ç”Ÿæˆæ–°çš„é•¿åºåˆ—
- **è‡ªåŠ¨å­˜æ¡£**: æ¯ç”Ÿæˆä¸€ä¸ªé•¿åºåˆ—ï¼Œè‡ªåŠ¨å­˜å‚¨ä¸º.h5æ–‡ä»¶
- **é˜²é‡åæœºåˆ¶**: æ—¶é—´æˆ³+ç´¢å¼•+éšæœºåç¼€+UUIDå››çº§é˜²é‡åä¿æŠ¤
- **ä¼˜ç‚¹**: æ— éœ€é¢„å ç£ç›˜ç©ºé—´ï¼Œè¾¹è®­ç»ƒè¾¹å»ºç«‹æ•°æ®é›†
- **å­˜æ¡£è·¯å¾„**: `data/generated_h5/{train|val}/sequence_timestamp_index[_suffix].h5`

#### æ¨¡å¼äºŒï¼šè¯»å–é¢„ç”Ÿæˆæ•°æ® (Load-Pregenerated)  
- **æµç¨‹**: ç›´æ¥ä»ç£ç›˜è¯»å–å·²å­˜æ¡£çš„.h5æ–‡ä»¶
- **ä¼˜ç‚¹**: å¯åŠ¨å¿«ï¼ŒCPUå ç”¨ä½ï¼Œè®­ç»ƒç¨³å®šå¯å¤ç°
- **æ™ºèƒ½åŠ è½½**: è‡ªåŠ¨å‘ç°ç›®å½•ä¸­æ‰€æœ‰.h5æ–‡ä»¶å¹¶åŠ è½½

### ğŸ—ï¸ æ ¸å¿ƒæ¶æ„ç»„ä»¶

#### 1. UnifiedSequenceDataset (src/unified_dataset.py)
- **ç»Ÿä¸€æ¥å£**: é…ç½®é©±åŠ¨çš„æ¨¡å¼åˆ‡æ¢
- **H5å­˜æ¡£**: å®Œæ•´çš„åºåˆ—ç‰¹å¾å’Œæ ‡ç­¾å­˜å‚¨
- **é˜²é‡å**: å¤šçº§æ–‡ä»¶åå†²çªæ£€æµ‹å’Œè§£å†³
- **é”™è¯¯å¤„ç†**: å­˜æ¡£å¤±è´¥æ—¶çš„graceful fallback

#### 2. Enhanced Trainer (src/trainer.py) 
- **TBPTTåŒå¾ªç¯**: å¤–å¾ªç¯å¤„ç†é•¿åºåˆ—ï¼Œå†…å¾ªç¯chunkåˆ‡åˆ†
- **å…¨å±€æ­¥æ•°æ§åˆ¶**: åŸºäºglobal_stepçš„ç²¾ç¡®è®­ç»ƒè¿›åº¦
- **æ™ºèƒ½æ–­ç‚¹ç»­è®­**: è‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤æœ€æ–°checkpoint
- **å·¥ä¸šçº§æ£€æŸ¥ç‚¹**: åŸºäºæ­¥æ•°çš„æ–‡ä»¶å‘½åå’ŒçŠ¶æ€ä¿å­˜

#### 3. é…ç½®ç³»ç»Ÿ (configs/config.yaml)
```yaml
data_pipeline:
  mode: 'generate'  # 'generate' æˆ– 'load' 
  h5_archive_path: 'data/generated_h5'

training:
  chunk_size: 8192  # TBPTTæˆªæ–­é•¿åº¦
  num_long_sequences_per_epoch: 1  # æ¯epochåºåˆ—æ•°
  validate_every_n_steps: 5000
  save_every_n_steps: 1000
```

## ğŸ“Š å½“å‰éªŒè¯çŠ¶æ€

### âœ… Generateæ¨¡å¼ - å®Œå…¨éªŒè¯
- âœ… TBPTTåŒå¾ªç¯è®­ç»ƒæ­£å¸¸å·¥ä½œ
- âœ… H5è‡ªåŠ¨å­˜æ¡£æˆåŠŸï¼Œé˜²é‡åæœºåˆ¶æœ‰æ•ˆ
- âœ… æ–­ç‚¹ç»­è®­æ­£å¸¸å·¥ä½œ
- âœ… å†…å­˜ä½¿ç”¨å®‰å…¨(<1GB)
- âœ… è¾“å‡ºæ¸…ç†å®Œæˆ - æ— å†—ä½™debugä¿¡æ¯

### ğŸ”„ Loadæ¨¡å¼ - å¾…æµ‹è¯•
- ä»Generateæ¨¡å¼äº§ç”Ÿçš„H5æ–‡ä»¶åŠ è½½è®­ç»ƒ

## ğŸ¯ æ•°æ®ç”Ÿæˆç®¡çº¿

### DSECèƒŒæ™¯äº‹ä»¶
- **æºæ–‡ä»¶**: `data/bg_events/*.h5` (7ä¸ªæ–‡ä»¶)
- **æ€»å®¹é‡**: 32.7äº¿äº‹ä»¶ï¼Œ291ä¸ªæ—¶é—´çª—å£
- **æ—¶é—´çª—å£**: 100-300mséšæœºé•¿åº¦
- **æ ¼å¼**: è‡ªåŠ¨æ—¶é—´æˆ³å½’ä¸€åŒ–ä»0å¼€å§‹

### DVSç‚«å…‰äº‹ä»¶
- **ä»¿çœŸå™¨**: DVS-Voltmeterç‰©ç†ä»¿çœŸ
- **å‚æ•°ä¼˜åŒ–**: k1éšæœºåŒ–(0.5-5.265)ï¼Œæå‡æ•°æ®å¤šæ ·æ€§
- **æ—¶é—´çª—å£**: 50-150mséšæœºé•¿åº¦
- **è¿åŠ¨æ¨¡å¼**: 0-180åƒç´ éšæœºè¿åŠ¨

### Flare7Kå›¾åƒæ•°æ®é›†
- **å›¾åƒæº**: 2ä¸ªCompound_Flareç›®å½•ï¼Œå…±5962å¼ ç‚«å…‰å›¾åƒ
- **è·¯å¾„1**: `Flare-R/Compound_Flare/` (962å¼ )
- **è·¯å¾„2**: `Flare7K/Scattering_Flare/Compound_Flare/` (5000å¼ )

## ğŸ”§ ç‰¹å¾æå–ä¸æ¨¡å‹

### å½“å‰ç‰¹å¾è®¾ç½®
- **ç‰¹å¾ç»´åº¦**: 4Då¿«é€Ÿç‰¹å¾ [x_norm, y_norm, dt, polarity]
- **å¤„ç†æ–¹å¼**: çº¯NumPyå‘é‡åŒ–ï¼Œæ¯«ç§’çº§å®Œæˆ
- **PFDçŠ¶æ€**: æš‚æ—¶ç¦ç”¨ï¼Œ11D PFDç‰¹å¾è®¾è®¡å·²å®Œå¤‡å¾…æ¢å¤

### æ¨¡å‹æ¶æ„
- **å‚æ•°é‡**: 25,359,361ä¸ªå¯è®­ç»ƒå‚æ•°
- **æ¶æ„**: Mamba backboneï¼Œ4å±‚ï¼Œd_model=128
- **è¾“å‡º**: äºŒå…ƒåˆ†ç±»ï¼ˆäº‹ä»¶å»å™ªï¼‰

## ğŸš€ è¿è¡ŒæŒ‡å—

### Generateæ¨¡å¼ (å½“å‰é»˜è®¤)
```bash
source /home/lanpoknlanpokn/miniconda3/bin/activate event_flare
python main.py --config configs/config.yaml
```

### Debugæ¨¡å¼ (æ¸…ç†è¾“å‡ºç‰ˆæœ¬)
```bash
python main.py --config configs/config.yaml --debug
```

### Loadæ¨¡å¼ (éœ€å…ˆè¿è¡ŒGenerateç”Ÿæˆæ•°æ®)
```bash
# 1. ä¿®æ”¹configs/config.yaml: data_pipeline.mode: 'load'
# 2. è¿è¡Œè®­ç»ƒ
python main.py --config configs/config.yaml
```

## ğŸ“ é‡è¦å˜æ›´è®°å½• (2025-08-08)

### æ–°å¢åŠŸèƒ½
- âœ… **ç»Ÿä¸€åŒæ¨¡å¼æ¶æ„**: å®Œæ•´çš„generate/loadæ¨¡å¼æ”¯æŒ
- âœ… **H5é˜²é‡åæœºåˆ¶**: å¤šçº§æ–‡ä»¶åå†²çªè§£å†³
- âœ… **è¾“å‡ºæ¸…ç†**: ç§»é™¤å†—ä½™debugä¿¡æ¯ï¼Œä¿ç•™æ ¸å¿ƒè®­ç»ƒä¿¡æ¯
- âœ… **æ–­ç‚¹ç»­è®­å¢å¼º**: åŸºäºglobal_stepçš„ç²¾ç¡®æ¢å¤

### ä»£ç æ–‡ä»¶çŠ¶æ€
- **æ–°å¢**: `src/unified_dataset.py` - åŒæ¨¡å¼ç»Ÿä¸€æ•°æ®é›†
- **é‡æ„**: `src/trainer.py` - TBPTT + æ–­ç‚¹ç»­è®­
- **æ›´æ–°**: `main.py` - ç»Ÿä¸€æ•°æ®åŠ è½½å™¨é›†æˆ
- **æ¸…ç†**: `src/epoch_iteration_dataset.py` - æ³¨é‡Šå†—ä½™print
- **æ¸…ç†**: `src/flare_synthesis.py` - æ³¨é‡Šè¯¦ç»†æ­¥éª¤è¾“å‡º
- **æ¸…ç†**: `src/dvs_flare_integration.py` - ä¿®å¤è¯­æ³•é”™è¯¯ï¼Œæ³¨é‡Šverboseè¾“å‡º

## ğŸ¯ ä¸‹ä¸€æ­¥å¼€å‘é‡ç‚¹

1. **Loadæ¨¡å¼éªŒè¯**: æµ‹è¯•H5æ–‡ä»¶åŠ è½½è®­ç»ƒçš„å®Œæ•´æµç¨‹
2. **æ‰¹é‡æ•°æ®ç”Ÿæˆ**: æ”¯æŒä¸€æ¬¡æ€§ç”Ÿæˆå¤§é‡é¢„è®­ç»ƒæ•°æ®
3. **PFDç‰¹å¾æ¢å¤**: åœ¨è®­ç»ƒç¨³å®šåæ¢å¤11Dç‰©ç†ç‰¹å¾
4. **æ€§èƒ½ä¼˜åŒ–**: å¤§è§„æ¨¡è®­ç»ƒé…ç½®è°ƒä¼˜

## ğŸš¨ å†…å­˜å®‰å…¨é…ç½® (å†å²éªŒè¯)
- **batch_size**: å›ºå®šä¸º2 (é˜²æ­¢å†…å­˜çˆ†ç‚¸)
- **chunk_size**: 8192 (TBPTTæˆªæ–­é•¿åº¦)
- **max_samples_debug**: 8 (debugæ¨¡å¼é™åˆ¶)

## ğŸ” Debugç³»ç»ŸçŠ¶æ€
- **å¯è§†åŒ–ç³»ç»Ÿ**: å®Œæ•´ä¿ç•™ï¼ŒåŒ…æ‹¬å¤šåˆ†è¾¨ç‡äº‹ä»¶åˆ†æ
- **è¾“å‡ºæ¸…ç†**: ç§»é™¤å†—ä½™æ­¥éª¤ä¿¡æ¯ï¼Œä¿ç•™æ ¸å¿ƒçŠ¶æ€
- **Debugç›®å½•**: `output/debug_visualizations/`

## ğŸ“ˆ æ€§èƒ½åŸºå‡†
- **åºåˆ—é•¿åº¦**: é€šå¸¸60ä¸‡-100ä¸‡äº‹ä»¶
- **ç”Ÿæˆæ—¶é—´**: 40-120ç§’/åºåˆ— (åŒ…å«DVSä»¿çœŸ)
- **ç‰¹å¾æå–**: <0.02ç§’ (4Då¿«é€Ÿç‰¹å¾)
- **å†…å­˜å³°å€¼**: <1GB (ç”Ÿæˆ+è®­ç»ƒå…¨æµç¨‹)
- **checkpointæ¢å¤**: è‡ªåŠ¨æ£€æµ‹ï¼Œæ”¯æŒä¸­æ–­ç»­è®­

---

*æœ€åæ›´æ–°: 2025-08-08 - å®ŒæˆTBPTTæ¶æ„é‡æ„ï¼Œè¾“å‡ºæ¸…ç†ï¼ŒH5é˜²é‡åæœºåˆ¶*