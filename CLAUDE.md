# EventMamba-FX Project Memory

## Project Overview
EventMamba-FX is a Feature-Augmented Mamba model for real-time event denoising and artifact removal from event camera streams. 

## Environment Setup ğŸ”§ CRITICAL
- **MUST USE**: `source /home/lanpoknlanpokn/miniconda3/bin/activate event_flare`
- Environment already has all dependencies: PyTorch, Mamba SSM, etc.
- Python 3.10.18 with CUDA support

## ğŸš€ CURRENT SYSTEM STATUS: UNIFIED DUAL-MODE TBPTT ARCHITECTURE (2025-08-08)

### âœ… å®Œæˆçš„é‡å¤§æ¶æ„é‡æ„
EventMamba-FXå·²ä»ä¼ ç»Ÿepoch-iterationæ¶æ„æˆåŠŸé‡æ„ä¸º**å·¥ä¸šçº§åŒæ¨¡å¼TBPTTæ¶æ„**ï¼Œå®ç°äº†"é•¿åºåˆ—å·¥å‚ + åºåˆ—æ¶ˆåŒ–å™¨"è®¾è®¡æ¨¡å¼ã€‚

### ğŸ¯ åŒæ¨¡å¼è®¾è®¡æ ¸å¿ƒ

#### æ¨¡å¼ä¸€ï¼šæ•°æ®é¢„ç”Ÿæˆ (Generate Mode)
- **æµç¨‹**: çº¯æ•°æ®ç”Ÿæˆï¼Œç”Ÿæˆå®Œæ¯•åè‡ªåŠ¨é€€å‡º
- **è‡ªåŠ¨å­˜æ¡£**: æ¯ç”Ÿæˆä¸€ä¸ªé•¿åºåˆ—ï¼Œè‡ªåŠ¨å­˜å‚¨ä¸º.h5æ–‡ä»¶
- **é˜²é‡åæœºåˆ¶**: æ—¶é—´æˆ³+ç´¢å¼•+éšæœºåç¼€+UUIDå››çº§é˜²é‡åä¿æŠ¤
- **å­˜æ¡£è·¯å¾„**: `data/generated_h5/{train|val}/sequence_timestamp_index[_suffix].h5`

#### æ¨¡å¼äºŒï¼šæ¨¡å‹è®­ç»ƒ (Load Mode)  
- **æµç¨‹**: ä»H5æ–‡ä»¶åŠ è½½é¢„ç”Ÿæˆæ•°æ®è¿›è¡Œè®­ç»ƒ
- **ä¼˜ç‚¹**: å¯åŠ¨å¿«ï¼ŒCPUå ç”¨ä½ï¼Œè®­ç»ƒç¨³å®šå¯å¤ç°
- **æ–­ç‚¹ç»­è®­**: æ­£ç¡®æ¢å¤best_val_losså’Œå…¨éƒ¨è®­ç»ƒçŠ¶æ€

### ğŸ—ï¸ æ ¸å¿ƒæ¶æ„ç»„ä»¶

#### 1. UnifiedSequenceDataset (src/unified_dataset.py)
- **ç»Ÿä¸€æ¥å£**: é…ç½®é©±åŠ¨çš„æ¨¡å¼åˆ‡æ¢
- **H5å­˜æ¡£**: å®Œæ•´çš„åºåˆ—ç‰¹å¾å’Œæ ‡ç­¾å­˜å‚¨
- **é˜²é‡å**: å¤šçº§æ–‡ä»¶åå†²çªæ£€æµ‹å’Œè§£å†³
- **é”™è¯¯å¤„ç†**: å­˜æ¡£å¤±è´¥æ—¶çš„graceful fallback

#### 2. Enhanced Trainer (src/trainer.py) 
- **TBPTTåŒå¾ªç¯**: å¤–å¾ªç¯å¤„ç†é•¿åºåˆ—ï¼Œå†…å¾ªç¯chunkåˆ‡åˆ†
- **å…¨å±€æ­¥æ•°æ§åˆ¶**: åŸºäºglobal_stepçš„ç²¾ç¡®è®­ç»ƒè¿›åº¦
- **æ™ºèƒ½æ–­ç‚¹ç»­è®­**: è‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤æœ€æ–°checkpoint
- **å·¥ä¸šçº§æ£€æŸ¥ç‚¹**: åŸºäºæ­¥æ•°çš„æ–‡ä»¶å‘½åå’ŒçŠ¶æ€ä¿å­˜

#### 3. é…ç½®ç³»ç»Ÿ (configs/config.yaml)
```yaml
data_pipeline:
  mode: 'generate'  # 'generate' æˆ– 'load' 
  h5_archive_path: 'data/generated_h5'

training:
  epochs: 10  # è®­ç»ƒè½®æ•°
  chunk_size: 8192  # TBPTTæˆªæ–­é•¿åº¦
  num_long_sequences_per_epoch: 1000  # æ¯epochåºåˆ—æ•°ï¼ˆè®­ç»ƒï¼‰
  validate_every_n_steps: 20000
  save_every_n_steps: 20000

evaluation:
  num_long_sequences_per_epoch: 50  # éªŒè¯åºåˆ—æ•°
```

## ğŸ“Š å½“å‰éªŒè¯çŠ¶æ€

### âœ… Generateæ¨¡å¼ - å®Œå…¨éªŒè¯
- âœ… TBPTTåŒå¾ªç¯è®­ç»ƒæ­£å¸¸å·¥ä½œ
- âœ… H5è‡ªåŠ¨å­˜æ¡£æˆåŠŸï¼Œé˜²é‡åæœºåˆ¶æœ‰æ•ˆ
- âœ… æ–­ç‚¹ç»­è®­æ­£å¸¸å·¥ä½œ
- âœ… å†…å­˜ä½¿ç”¨å®‰å…¨(<1GB)
- âœ… è¾“å‡ºæ¸…ç†å®Œæˆ - æ— å†—ä½™debugä¿¡æ¯

### âœ… Loadæ¨¡å¼ - å½“å‰è¿è¡Œ
- âœ… ä»Generateæ¨¡å¼äº§ç”Ÿçš„H5æ–‡ä»¶åŠ è½½è®­ç»ƒæ­£å¸¸
- âœ… æ–­ç‚¹ç»­è®­ï¼šæ­£ç¡®æ¢å¤best_val_losså†å²æœ€ä½³å€¼
- âœ… ä¿®å¤tqdmåµŒå¥—æ˜¾ç¤ºå†²çªï¼šç¦ç”¨éªŒè¯æ—¶è¿›åº¦æ¡

## ğŸ¯ æ•°æ®ç”Ÿæˆç®¡çº¿

### DSECèƒŒæ™¯äº‹ä»¶
- **æºæ–‡ä»¶**: `data/bg_events/*.h5` (7ä¸ªæ–‡ä»¶)
- **æ€»å®¹é‡**: 32.7äº¿äº‹ä»¶ï¼Œ291ä¸ªæ—¶é—´çª—å£
- **æ—¶é—´çª—å£**: 100-300mséšæœºé•¿åº¦
- **æ ¼å¼**: è‡ªåŠ¨æ—¶é—´æˆ³å½’ä¸€åŒ–ä»0å¼€å§‹

### DVSç‚«å…‰äº‹ä»¶
- **ä»¿çœŸå™¨**: DVS-Voltmeterç‰©ç†ä»¿çœŸ
- **å‚æ•°ä¼˜åŒ–**: k1éšæœºåŒ–(0.5-5.265)ï¼Œæå‡æ•°æ®å¤šæ ·æ€§
- **æ—¶é—´çª—å£**: 50-150mséšæœºé•¿åº¦
- **è¿åŠ¨æ¨¡å¼**: 0-180åƒç´ éšæœºè¿åŠ¨

### Flare7Kå›¾åƒæ•°æ®é›†
- **å›¾åƒæº**: 2ä¸ªCompound_Flareç›®å½•ï¼Œå…±5962å¼ ç‚«å…‰å›¾åƒ
- **è·¯å¾„1**: `Flare-R/Compound_Flare/` (962å¼ )
- **è·¯å¾„2**: `Flare7K/Scattering_Flare/Compound_Flare/` (5000å¼ )

## ğŸ”§ ç‰¹å¾æå–ä¸æ¨¡å‹

### å½“å‰ç‰¹å¾è®¾ç½®
- **ç‰¹å¾ç»´åº¦**: 4Då¿«é€Ÿç‰¹å¾ [x_norm, y_norm, dt, polarity]
- **å¤„ç†æ–¹å¼**: çº¯NumPyå‘é‡åŒ–ï¼Œæ¯«ç§’çº§å®Œæˆ
- **PFDçŠ¶æ€**: æš‚æ—¶ç¦ç”¨ï¼Œ11D PFDç‰¹å¾è®¾è®¡å·²å®Œå¤‡å¾…æ¢å¤

### æ¨¡å‹æ¶æ„
- **å‚æ•°é‡**: 25,359,361ä¸ªå¯è®­ç»ƒå‚æ•°
- **æ¶æ„**: Mamba backboneï¼Œ12å±‚ï¼Œd_model=512ï¼Œd_state=64
- **è¾“å‡º**: äºŒå…ƒåˆ†ç±»ï¼ˆäº‹ä»¶å»å™ªï¼‰

## ğŸš€ è¿è¡ŒæŒ‡å—

### Generateæ¨¡å¼ (å½“å‰é»˜è®¤)
```bash
source /home/lanpoknlanpokn/miniconda3/bin/activate event_flare
python main.py --config configs/config.yaml
```

### Debugæ¨¡å¼ (æ¸…ç†è¾“å‡ºç‰ˆæœ¬)
```bash
python main.py --config configs/config.yaml --debug
```

### Loadæ¨¡å¼ (éœ€å…ˆè¿è¡ŒGenerateç”Ÿæˆæ•°æ®)
```bash
# 1. ä¿®æ”¹configs/config.yaml: data_pipeline.mode: 'load'
# 2. è¿è¡Œè®­ç»ƒ
python main.py --config configs/config.yaml
```

## ğŸ“ é‡è¦å˜æ›´è®°å½• (2025-08-08)

### æ–°å¢åŠŸèƒ½
- âœ… **ç»Ÿä¸€åŒæ¨¡å¼æ¶æ„**: å®Œæ•´çš„generate/loadæ¨¡å¼æ”¯æŒ
- âœ… **H5é˜²é‡åæœºåˆ¶**: å¤šçº§æ–‡ä»¶åå†²çªè§£å†³
- âœ… **è¾“å‡ºæ¸…ç†**: ç§»é™¤å†—ä½™debugä¿¡æ¯ï¼Œä¿ç•™æ ¸å¿ƒè®­ç»ƒä¿¡æ¯
- âœ… **æ–­ç‚¹ç»­è®­å¢å¼º**: åŸºäºglobal_stepçš„ç²¾ç¡®æ¢å¤

### ä»£ç æ–‡ä»¶çŠ¶æ€
- **æ–°å¢**: `src/unified_dataset.py` - åŒæ¨¡å¼ç»Ÿä¸€æ•°æ®é›†
- **é‡æ„**: `src/trainer.py` - TBPTT + æ–­ç‚¹ç»­è®­
- **æ›´æ–°**: `main.py` - ç»Ÿä¸€æ•°æ®åŠ è½½å™¨é›†æˆ
- **æ¸…ç†**: `src/epoch_iteration_dataset.py` - æ³¨é‡Šå†—ä½™print
- **æ¸…ç†**: `src/flare_synthesis.py` - æ³¨é‡Šè¯¦ç»†æ­¥éª¤è¾“å‡º
- **æ¸…ç†**: `src/dvs_flare_integration.py` - ä¿®å¤è¯­æ³•é”™è¯¯ï¼Œæ³¨é‡Šverboseè¾“å‡º

## ğŸ” æ¨ç†ç³»ç»Ÿ (2025-08-14 é‡æ„)

### âœ… ç®€æ´çš„ç”Ÿäº§çº§æ¨ç†æ¶æ„
EventMamba-FXç°å·²é‡æ„ä¸º**ç®€æ´é«˜æ•ˆçš„ç”Ÿäº§çº§æ¨ç†ç³»ç»Ÿ**ï¼Œæ‰€æœ‰inferenceä»£ç é›†ä¸­åœ¨`src/inference/`æ¨¡å—ä¸­ã€‚

#### é‡æ„åçš„æ ¸å¿ƒç»„ä»¶

1. **inference.py** - ç®€æ´çš„æ¨ç†å…¥å£ï¼ˆä»…73è¡Œï¼‰
   - **å•ä¸€èŒè´£**: çº¯æ¨ç†åŠŸèƒ½ï¼Œæ— å¯è§†åŒ–å’Œè°ƒè¯•ä»£ç 
   - **å‚æ•°åŒ–é…ç½®**: æ”¯æŒé˜ˆå€¼ã€å—å¤§å°ã€æ—¶é—´é™åˆ¶ç­‰å‚æ•°
   - **è‡ªåŠ¨è®¾å¤‡æ£€æµ‹**: CUDA/CPUè‡ªåŠ¨é€‰æ‹©

2. **src/inference/predictor.py** - æ ¸å¿ƒé¢„æµ‹å™¨
   - **æµå¼å¤„ç†**: é€å—å¤„ç†å¤§æ–‡ä»¶ï¼Œé˜²æ­¢OOM
   - **ä¼˜åŒ–chunk_size**: æ¨ç†æ—¶ä½¿ç”¨10å€è®­ç»ƒchunk_size
   - **å†…å­˜ç®¡ç†**: GPUç¼“å­˜æ¸…ç†å’Œåƒåœ¾å›æ”¶

3. **src/inference/h5_stream_reader.py** - H5æµå¼è¯»å–å™¨
   - **åˆ†å—è¯»å–**: å¯é…ç½®å—å¤§å°ï¼Œé¿å…å†…å­˜æº¢å‡º
   - **æ—¶é—´é™åˆ¶**: æ”¯æŒå¤„ç†æŒ‡å®šæ—¶é•¿çš„äº‹ä»¶
   - **æ ¼å¼æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«DSEC vs è®­ç»ƒæ•°æ®æ ¼å¼

### ğŸš€ æ¨ç†ä½¿ç”¨æ–¹æ³•

**åŸºæœ¬æ¨ç†**ï¼ˆå¤„ç†å‰1ç§’äº‹ä»¶ï¼‰:
```bash
python inference.py \
    --config configs/config.yaml \
    --checkpoint checkpoints/best_model.pth \
    --input data/inference/zurich_city_12_a.h5 \
    --output data/inference/clean_output.h5 \
    --time-limit 1.0
```

**å†…å­˜ä¼˜åŒ–æ¨ç†**:
```bash
python inference.py \
    --config configs/config.yaml \
    --checkpoint checkpoints/best_model.pth \
    --input data/inference/zurich_city_12_a.h5 \
    --output data/inference/clean_output.h5 \
    --time-limit 0.1 \
    --block-size 1000000  # å‡å°å—å¤§å°é˜²æ­¢OOM
```


### ğŸ“Š éªŒè¯ç»“æœ

#### DSECèƒŒæ™¯æ•°æ® (zurich_city_12_a.h5å‰100ms)
- **åŸå§‹äº‹ä»¶æ•°**: 1,817,979
- **å»å™ªåäº‹ä»¶æ•°**: 1,644,775  
- **ç‚«å…‰äº‹ä»¶ç§»é™¤**: 173,204 (9.53%)
- **ç»†ç²’åº¦åˆ†æ**:
  - å‰1ms: åŸå§‹14,070 â†’ å»å™ª13,632 (å·®å¼‚438ä¸ª)

#### ğŸ”¬ Checkpointå¯¹æ¯”æµ‹è¯• (2025-08-11)
åœ¨åˆæˆç‚«å…‰æµ‹è¯•æ•°æ®(55,000äº‹ä»¶)ä¸Šå¯¹æ¯”ä¸¤ä¸ªæ¨¡å‹checkpointçš„æ€§èƒ½:

**best_model.pth vs ckpt_step_00065000.pth @ threshold 0.5:**
- **best_model.pth**: ç§»é™¤3,174äº‹ä»¶ (5.77%)
- **ckpt_step_00065000.pth**: ç§»é™¤7,403äº‹ä»¶ (13.46%) 
- **æ€§èƒ½æå‡**: 65k checkpointç§»é™¤ç‚«å…‰äº‹ä»¶èƒ½åŠ›æå‡133%

**å¤šé˜ˆå€¼æ€§èƒ½å¯¹æ¯”**:
| Threshold | best_model.pth | ckpt_step_00065000.pth |
|-----------|----------------|------------------------|
| 0.5       | 3,174 (5.77%)  | 7,403 (13.46%)        |
| 0.4       | 3,633 (6.61%)  | 7,904 (14.37%)        |  
| 0.3       | 4,175 (7.59%)  | 8,482 (15.42%)        |
| 0.2       | 4,946 (8.99%)  | 9,254 (16.83%)        |

**ç»“è®º**: ckpt_step_00065000.pthåœ¨æ‰€æœ‰é˜ˆå€¼ä¸‹éƒ½æ˜¾è‘—ä¼˜äºbest_model.pthï¼Œå…·æœ‰æ›´å¼ºçš„ç‚«å…‰æ£€æµ‹æ•æ„Ÿæ€§ã€‚

### ğŸ› ï¸ æ¨ç†ç³»ç»ŸæŠ€æœ¯è¦ç‚¹

#### H5æ–‡ä»¶è¯»å–é—®é¢˜è§£å†³ (2025-08-11)
**é—®é¢˜**: ç³»ç»Ÿå‡ºç°"Can't synchronously read data (can't open directory (/usr/local/hdf5/lib/plugin)"é”™è¯¯
**è§£å†³æ–¹æ¡ˆ**: åœ¨Pythonä»£ç ä¸­æ·»åŠ `import hdf5plugin`å³å¯è§£å†³
```python
import h5py
import hdf5plugin  # å¿…é¡»å¯¼å…¥ï¼
```

#### æ¨ç†å‘½ä»¤è¡Œæ ‡å‡†æ ¼å¼
```bash
python inference.py \
    --config configs/config.yaml \
    --checkpoint checkpoints/ckpt_step_00065000.pth \
    --input data/inference/test_synthetic_flare.h5 \
    --output data/inference/output_clean.h5 \
    --threshold 0.5 \
    --time-limit 0.1
```

#### éƒ¨ç½²ä¼˜åŒ–ç‰¹æ€§
- **æ¨¡å—åŒ–è®¾è®¡**: inferenceåŠŸèƒ½å®Œå…¨ç‹¬ç«‹åœ¨`src/inference/`
- **æœ€å°ä¾èµ–**: åˆ é™¤äº†æ‰€æœ‰å¯è§†åŒ–ç›¸å…³ä»£ç å’Œä¾èµ–
- **ä¼ è¾“å‹å¥½**: æœåŠ¡å™¨éƒ¨ç½²æ—¶åªéœ€ä¼ è¾“å°å·§çš„`src/`æ–‡ä»¶å¤¹



### ğŸ”§ æ¨ç†ç³»ç»Ÿç‰¹æ€§

- âœ… **OOMé˜²æŠ¤**: åˆ†å—å¤„ç†ä»»æ„å¤§å°H5æ–‡ä»¶
- âœ… **æ—¶é—´æ§åˆ¶**: å¯é™åˆ¶å¤„ç†ç‰¹å®šæ—¶é•¿çš„äº‹ä»¶
- âœ… **å†…å­˜ä¼˜åŒ–**: 10å€chunk_sizeæå‡æ¨ç†æ•ˆç‡
- âœ… **ç”Ÿäº§å°±ç»ª**: ç®€æ´APIï¼Œæ— å¯è§†åŒ–ä¾èµ–
- âœ… **DSECå…¼å®¹**: å®Œç¾æ”¯æŒDSECæ•°æ®é›†æ ¼å¼
- âœ… **æ¨¡å—åŒ–**: æ‰€æœ‰inferenceä»£ç é›†ä¸­åœ¨`src/inference/`

## ğŸ¯ ç³»ç»ŸçŠ¶æ€æ€»ç»“

### âœ… å·²å®Œæˆæ¨¡å—
1. **åŒæ¨¡å¼TBPTTæ¶æ„**: Generate/Loadæ¨¡å¼å®Œå…¨å·¥ä½œ
2. **ç®€æ´æ¨ç†ç³»ç»Ÿ**: ç”Ÿäº§çº§inferenceï¼Œæ— å¯è§†åŒ–ä¾èµ–
3. **å†…å­˜å®‰å…¨è®­ç»ƒ**: <1GBå†…å­˜ä½¿ç”¨ï¼Œæ”¯æŒæ–­ç‚¹ç»­è®­
4. **æ¨¡å—åŒ–ä»£ç ç»“æ„**: ä¾¿äºæœåŠ¡å™¨éƒ¨ç½²å’Œä»£ç ä¼ è¾“

### ğŸ”„ å½“å‰é…ç½®
- **ç‰¹å¾**: 4Då¿«é€Ÿç‰¹å¾ (11D PFDå¯æ¢å¤)
- **æ¨¡å‹**: 25Må‚æ•°Mambaæ¶æ„
- **è®­ç»ƒ**: TBPTT chunk_size=8192
- **æ¨ç†**: æµå¼å¤„ç†ï¼Œå¯é…ç½®å—å¤§å°

## ğŸš¨ å†…å­˜å®‰å…¨é…ç½® (å†å²éªŒè¯)
- **batch_size**: å›ºå®šä¸º1 (TBPTTéœ€æ±‚)
- **chunk_size**: 8192 (TBPTTæˆªæ–­é•¿åº¦)
- **debugæ¨¡å¼**: è‡ªåŠ¨å°†åºåˆ—æ•°å‡å°‘åˆ°8ä¸ªè¿›è¡Œå¿«é€ŸéªŒè¯

## ğŸ” Debugç³»ç»ŸçŠ¶æ€
- **å¯è§†åŒ–ç³»ç»Ÿ**: å®Œæ•´ä¿ç•™ï¼ŒåŒ…æ‹¬å¤šåˆ†è¾¨ç‡äº‹ä»¶åˆ†æ
- **è¾“å‡ºæ¸…ç†**: ç§»é™¤å†—ä½™æ­¥éª¤ä¿¡æ¯ï¼Œä¿ç•™æ ¸å¿ƒçŠ¶æ€
- **Debugç›®å½•**: `output/debug_visualizations/`

## ğŸ“ˆ æ€§èƒ½åŸºå‡†
- **åºåˆ—é•¿åº¦**: é€šå¸¸60ä¸‡-100ä¸‡äº‹ä»¶
- **ç”Ÿæˆæ—¶é—´**: 40-120ç§’/åºåˆ— (åŒ…å«DVSä»¿çœŸ)
- **ç‰¹å¾æå–**: <0.02ç§’ (4Då¿«é€Ÿç‰¹å¾)
- **å†…å­˜å³°å€¼**: <1GB (ç”Ÿæˆ+è®­ç»ƒå…¨æµç¨‹)
- **checkpointæ¢å¤**: è‡ªåŠ¨æ£€æµ‹ï¼Œæ”¯æŒä¸­æ–­ç»­è®­

---

*æœ€åæ›´æ–°: 2025-08-14 - å®Œæˆinferenceç³»ç»Ÿé‡æ„ï¼Œåˆ é™¤å¯è§†åŒ–ä¾èµ–ï¼Œä¼˜åŒ–æœåŠ¡å™¨éƒ¨ç½²ç»“æ„*