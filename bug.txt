Physics Event Composer Bug Report
=====================================
æŠ¥å‘Šæ—¶é—´: 2025-08-27
æŠ¥å‘Šäºº: Claude Code

## ğŸ› Bugæ¦‚è¿°
ç‰©ç†æ··åˆæ¨¡å‹(_merge_events_physicsæ–¹æ³•)å­˜åœ¨NumPyæ•°æ®ç±»å‹è½¬æ¢é”™è¯¯ï¼Œå¯¼è‡´æ— æ³•æ­£å¸¸å·¥ä½œã€‚

## âŒ åŸå§‹é”™è¯¯ä¿¡æ¯
```
âŒ Error composing sequence for sequence_1756276170478_00000.h5: 
ufunc 'add' did not contain a loop with signature matching types (dtype('float32'), dtype('<U4')) -> None
```

## ğŸ“ Bugå®šä½
**ä¸»è¦é—®é¢˜æ–‡ä»¶**: `src/event_composer.py`
**å…·ä½“æ–¹æ³•**: `_merge_events_physics()` 
**é”™è¯¯è¡Œ**: æƒé‡å›¾è®¡ç®—éƒ¨åˆ†ï¼Œæ¶‰åŠnp.add.at()æˆ–forå¾ªç¯ç´¯ç§¯æ“ä½œ

## ğŸ” é”™è¯¯åˆ†æ
1. **é”™è¯¯ç±»å‹**: NumPy ufuncç±»å‹ç­¾åä¸åŒ¹é…
2. **æ¶‰åŠç±»å‹**: 
   - ç›®æ ‡æ•°ç»„: `dtype('float32')` - æƒé‡å›¾Y_est1/Y_est2
   - æºæ•°æ®: `dtype('<U4')` - å­—ç¬¦ä¸²ç±»å‹(4ä¸ªå­—ç¬¦)
3. **æ¨æµ‹åŸå› **: äº‹ä»¶æ•°ç»„ä¸­å¯èƒ½åŒ…å«å­—ç¬¦ä¸²æ•°æ®ï¼Œè€Œéçº¯æ•°å€¼æ•°æ®

## ğŸ› ï¸ å·²å°è¯•çš„è°ƒè¯•æ–¹æ³•

### 1. æ•°æ®ç±»å‹å¼ºåˆ¶è½¬æ¢
```python
# å°è¯•1: ä½¿ç”¨np.asarrayå¼ºåˆ¶è½¬æ¢
events1_safe = np.asarray(events1, dtype=np.float64)

# å°è¯•2: ä½¿ç”¨np.arrayé‡æ–°åˆ›å»º
events1_clean = np.array(events1, dtype=np.float64)
```

### 2. æ›¿æ¢np.add.at()ä¸ºæ‰‹åŠ¨å¾ªç¯
```python
# åŸæ¥ä½¿ç”¨np.add.at(Y_est1, (y1, x1), weight1) 
# æ”¹ä¸º:
for i in range(len(x1)):
    Y_est1[y1[i], x1[i]] += weight1
```

### 3. åæ ‡è¾¹ç•Œæ£€æŸ¥å’Œç±»å‹è½¬æ¢
```python
x1 = np.clip(events1_clean[:, 0].astype(np.int32), 0, W-1)
y1 = np.clip(events1_clean[:, 1].astype(np.int32), 0, H-1)
```

### 4. è°ƒè¯•ä¿¡æ¯æ”¶é›†
```python
print(f"DEBUG: events1 shape={events1.shape}, dtype={events1.dtype}")
print(f"DEBUG: events1[0]={events1[0]}")
# è¾“å‡ºæ˜¾ç¤ºæ•°æ®çœ‹èµ·æ¥æ­£å¸¸ï¼š
# DEBUG: events1 shape=(529238, 4), dtype=float64
# DEBUG: events1[0]=[  6. 107.   0.  -1.]
```

## ğŸ“ˆ è°ƒè¯•è¿‡ç¨‹ä¸­çš„å‘ç°

### æˆåŠŸçš„éƒ¨åˆ†
- EventComposeråˆå§‹åŒ–æ­£å¸¸
- Simpleæ–¹æ³•(_merge_events_simple)å®Œå…¨æ­£å¸¸å·¥ä½œ
- æ•°æ®åŠ è½½å’Œæ ¼å¼è½¬æ¢çœ‹èµ·æ¥æ­£ç¡®
- ç¬¬ä¸€ä¸ªnp.add.atæ“ä½œæœ‰æ—¶æˆåŠŸï¼Œæœ‰æ—¶å¤±è´¥

### å¼‚å¸¸è¡Œä¸º
- é”™è¯¯ä¸æ˜¯æ¯æ¬¡éƒ½åœ¨åŒä¸€åœ°æ–¹å‡ºç°
- æ•°æ®æœ¬èº«çœ‹èµ·æ¥æ˜¯æ­£ç¡®çš„æ•°å€¼æ ¼å¼
- é”™è¯¯ä¿¡æ¯ä¸­çš„`dtype('<U4')`å­—ç¬¦ä¸²ç±»å‹æ¥æºä¸æ˜

## ğŸš« æœªæˆåŠŸçš„ä¿®å¤å°è¯•

1. **æ•°æ®ç±»å‹å¼ºåˆ¶è½¬æ¢**: å¤šç§è½¬æ¢æ–¹å¼éƒ½æ— æ•ˆ
2. **æ›¿æ¢NumPyå‡½æ•°**: ç”¨æ‰‹åŠ¨å¾ªç¯æ›¿æ¢np.add.at()ä»ç„¶å¤±è´¥
3. **è¾“å…¥æ•°æ®éªŒè¯**: æ·»åŠ è¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼Œæ•°æ®çœ‹èµ·æ¥æ­£å¸¸
4. **å†…å­˜ç®¡ç†**: å°è¯•æ˜¾å¼æ•°ç»„å¤åˆ¶å’Œæ¸…ç†

## ğŸ”§ å¯èƒ½çš„æ ¹æœ¬åŸå› 

### å‡è®¾1: æ··åˆæ•°æ®ç±»å‹
äº‹ä»¶æ•°ç»„å¯èƒ½åœ¨æŸä¸ªåœ°æ–¹åŒ…å«äº†å­—ç¬¦ä¸²æ•°æ®ï¼Œä½†åœ¨ç›´æ¥æ‰“å°æ—¶è¢«æ©ç›–

### å‡è®¾2: å†…å­˜å¸ƒå±€é—®é¢˜  
NumPyæ•°ç»„çš„å†…å­˜å¸ƒå±€æˆ–æ­¥é•¿å¯èƒ½å¯¼è‡´ç±»å‹è§£é‡Šé”™è¯¯

### å‡è®¾3: éšå¼ç±»å‹æå‡
åœ¨æŸä¸ªè®¡ç®—è¿‡ç¨‹ä¸­ï¼Œæ•°å€¼æ•°æ®è¢«æ„å¤–æå‡ä¸ºå­—ç¬¦ä¸²ç±»å‹

### å‡è®¾4: å¹¶å‘æˆ–ç¼“å­˜é—®é¢˜
å¤šæ–¹æ³•å¹¶è¡Œæ‰§è¡Œå¯èƒ½å¯¼è‡´æ•°æ®ç«äº‰æˆ–ç¼“å­˜æ±¡æŸ“

## ğŸ“‹ å½“å‰çŠ¶æ€

### âœ… æ­£å¸¸å·¥ä½œçš„éƒ¨åˆ†
- Step 1: ç‚«å…‰äº‹ä»¶ç”Ÿæˆ âœ…
- Step 2 Simpleæ–¹æ³•: äº‹ä»¶åˆæˆ âœ…  
- Debugå¯è§†åŒ–: Simpleæ–¹æ³• âœ…
- è¾“å‡ºæ–‡ä»¶: Simpleæ–¹æ³•ç”Ÿæˆæ­£ç¡®çš„H5æ–‡ä»¶ âœ…

### âŒ å­˜åœ¨é—®é¢˜çš„éƒ¨åˆ†  
- Step 2 Physicsæ–¹æ³•: ç±»å‹è½¬æ¢é”™è¯¯ âŒ
- æƒé‡å›¾ç”Ÿæˆ: æ— æ³•å®Œæˆ âŒ
- åŒæ–¹æ³•å¯¹æ¯”: æ— æ³•è¿›è¡Œ âŒ

## ğŸ¯ å»ºè®®çš„ä¿®å¤æ–¹å‘

### çŸ­æœŸè§£å†³æ–¹æ¡ˆ
1. ç¦ç”¨Physicsæ–¹æ³•ï¼Œä½¿ç”¨ç¨³å®šçš„Simpleæ–¹æ³•
2. æä¾›ç”¨æˆ·æ¸…æ™°çš„é…ç½®æŒ‡å¯¼
3. ç¡®ä¿Simpleæ–¹æ³•çš„å®Œæ•´åŠŸèƒ½å¯ç”¨

### é•¿æœŸä¿®å¤ç­–ç•¥
1. **æ·±åº¦æ•°æ®æ£€æŸ¥**: æ·»åŠ æ›´è¯¦ç»†çš„æ•°æ®ç±»å‹éªŒè¯
2. **éš”ç¦»æµ‹è¯•**: å•ç‹¬æµ‹è¯•æƒé‡å›¾è®¡ç®—é€»è¾‘
3. **æ›¿ä»£å®ç°**: ä½¿ç”¨ä¸åŒçš„NumPy APIæˆ–çº¯Pythonå®ç°
4. **å†…å­˜åˆ†æ**: ä½¿ç”¨å†…å­˜åˆ†æå·¥å…·æ£€æŸ¥æ•°æ®å¸ƒå±€

## ğŸš€ ä¸´æ—¶è¿è¡ŒæŒ‡ä»¤

### ä½¿ç”¨Simpleæ–¹æ³•ï¼ˆæ¨èï¼‰
```bash
# ç¡®ä¿é…ç½®ä½¿ç”¨Simpleæ–¹æ³•
# configs/config.yaml:
# composition:
#   merge_method: "simple"
#   generate_both_methods: false

# è¿è¡ŒStep 2
source /home/lanpoknlanpokn/miniconda3/bin/activate event_flare
python main.py --step 2 --debug
```

### éªŒè¯è¾“å‡º
```bash
# æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
ls -la output/data/simple_method/background_with_light_events/
ls -la output/data/simple_method/full_scene_events/
ls -la output/debug/event_composition/
```

## ğŸ“Š å½±å“è¯„ä¼°
- **ä¸¥é‡ç¨‹åº¦**: ä¸­ç­‰ï¼ˆæ ¸å¿ƒåŠŸèƒ½å¯ç”¨ï¼Œæ–°ç‰¹æ€§å—é™ï¼‰  
- **ç”¨æˆ·å½±å“**: ä½ï¼ˆSimpleæ–¹æ³•æ»¡è¶³åŸºæœ¬éœ€æ±‚ï¼‰
- **å¼€å‘å½±å“**: ä¸­ç­‰ï¼ˆæ— æ³•è¿›è¡Œæ–¹æ³•å¯¹æ¯”å®éªŒï¼‰

## ğŸ” 2025-08-27 æ·±å…¥åˆ†æç»“æœ

### æ•°æ®æºåˆ†æ âœ…
**DSECèƒŒæ™¯äº‹ä»¶ç»“æ„**:
- âœ… ç¡®è®¤åŒ…å«é¢å¤–å­—æ®µ: `ms_to_idx`, `t_offset` (æ­£å¦‚é¢„æœŸ)
- âœ… æ•°æ®åŠ è½½å™¨æ­£ç¡®å¿½ç•¥é¢å¤–å­—æ®µï¼Œåªè¯»å–æ ‡å‡†DVSå­—æ®µ: `x`, `y`, `t`, `p`
- âœ… åŠ è½½çš„æ•°æ®å®Œå…¨æ˜¯æ•°å€¼å‹ (float64)ï¼Œæ— NaN/Inf/å­—ç¬¦ä¸²

**ç‚«å…‰äº‹ä»¶ç»“æ„**:
- âœ… æ ‡å‡†DVSæ ¼å¼: `t` (int64), `x` (uint16), `y` (uint16), `p` (int8)  
- âœ… æ•°æ®å®Œå…¨æ­£å¸¸ï¼Œæ— å¼‚å¸¸ç±»å‹

### åˆæ­¥ç»“è®º
**âŒ å‡è®¾è¢«æ¨ç¿»**: DSECé¢å¤–å­—æ®µä¸æ˜¯Bugæ ¹æº
- DSECæ•°æ®åŠ è½½å™¨æ­£ç¡®å¤„ç†äº†é¢å¤–å­—æ®µ
- æ‰€æœ‰äº‹ä»¶æ•°æ®éƒ½æ˜¯çº¯æ•°å€¼å‹ï¼Œæœªå‘ç°å­—ç¬¦ä¸²ç±»å‹æ•°æ®

**ğŸ” çœŸæ­£é—®é¢˜**: å¯èƒ½åœ¨`_merge_events_physics`çš„å…·ä½“å®ç°é€»è¾‘ä¸­
- æ•°æ®è¾“å…¥æ˜¯æ­£å¸¸çš„
- é—®é¢˜å¯èƒ½å‡ºç°åœ¨æƒé‡å›¾è®¡ç®—çš„æŸä¸ªæ­¥éª¤
- `dtype('<U4')`å­—ç¬¦ä¸²ç±»å‹çš„æ¥æºä»ç„¶æœªçŸ¥

## ğŸ“ ä¸‹ä¸€æ­¥è°ƒè¯•æ–¹å‘
1. **åˆ›å»ºæœ€å°åŒ–æµ‹è¯•ç”¨ä¾‹**ï¼šç›´æ¥æµ‹è¯•`_merge_events_physics`æ–¹æ³•
2. **é€è¡Œè°ƒè¯•**ï¼šåœ¨æƒé‡å›¾è®¡ç®—çš„æ¯ä¸ªæ­¥éª¤æ·»åŠ è¯¦ç»†ç±»å‹æ£€æŸ¥
3. **å†…å­˜å¸ƒå±€æ£€æŸ¥**ï¼šéªŒè¯NumPyæ•°ç»„çš„å†…å­˜è¿ç»­æ€§å’Œæ­¥é•¿
4. **æ›¿ä»£å®ç°**ï¼šå°è¯•å®Œå…¨ä¸åŒçš„æƒé‡å›¾è®¡ç®—æ–¹æ³•