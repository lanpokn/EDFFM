# ===================================================================
#      Configuration File for EventMamba-FX (TBPTT Architecture)
# ===================================================================

# --- 运行设置 (Run Settings) ---
run:
  mode: train         # 运行模式: 'train' or 'evaluate'

# --- 数据管线设置 (Data Pipeline Settings) ---
data_pipeline:
  # 🚨 关键开关: 'generate' 或 'load'
  mode: 'load'           # 'generate': 实时生成并存档, 'load': 从磁盘加载预生成数据
  
  # 'generate'和'load'模式都需要的存档路径
  h5_archive_path: 'data/generated_h5'

# --- 数据集设置 (Data Settings) ---
data:
  # 背景事件数据路径 (简化的H5文件目录)
  dsec_path: "data/bg_events"
  
  # Flare7Kpp数据集路径 (Compound_Flare散射数据)
  flare7k_path: "/mnt/e/2025/physical_deflare/Datasets/Flare7Kpp/Flare7Kpp"
  
  # 事件仿真器选择 (Event Simulator Selection)
  event_simulator:
    type: "dvs_voltmeter"
    
    # DVS-Voltmeter 配置
    dvs_voltmeter:
      simulator_path: "/mnt/e/2025/event_flick_flare/main/simulator/DVS-Voltmeter-main"
      timeout_sec: 60
      
      # DVS参数调优 (随机化k1参数)
      parameters:
        dvs346_k: [2.5, 20, 0.0001, 1e-7, 5e-9, 0.00001]
  
  # 随机化训练数据生成策略
  randomized_training:
    background_duration_range: [0.1, 0.3]      # 100-300ms背景事件窗口
    background_contains_flare_prob: 0.75       # 75%情况下背景包含炫光
    flare_only_prob: 0.1                       # 10%只有炫光事件
    background_only_prob: 0.15                 # 15%只有背景事件
    
  # 炫光合成参数
  flare_synthesis:
    realistic_frequencies:
      power_50hz: 100.0                  # 50Hz电网荧光灯频率
      power_60hz: 120.0                  # 60Hz电网荧光灯频率
    
    frequency_variation: 5.0             # ±5Hz随机变化
    min_samples_per_cycle: 48            # 每个闪烁周期最少采样点数
    max_fps: 6000                        # 最大帧率限制
    
    flicker_curves: ["sine", "square", "triangle", "exponential"]
    position_random: true                # 随机flare位置
    intensity_scale: [0.8, 1.2]        # 强度缩放范围
    
    duration_range: [0.05, 0.15]       # 炫光序列时长范围 50-150ms
    min_intensity_baseline: [0.0, 0.7]  # 最低强度随机范围 (0-70%)
    max_intensity: 1.0                  # 最大强度 (100%)
  
  # 事件相机分辨率 (DSEC分辨率)
  resolution_h: 480
  resolution_w: 640
  
  # Debug设置
  max_samples_debug: 8   # Debug模式样本数限制

# --- 模型架构设置 (Model Architecture Settings) ---
model:
  # 特征提取器输出的维度 (当前4维快速特征)
  input_feature_dim: 4
  
  # Mamba 骨干网络参数
  d_model: 512            # Mamba 内部工作维度
  d_state: 64             # SSM 状态空间维度
  d_conv: 5               # Mamba 内部1D卷积核大小
  expand: 4               # Mamba 块扩展因子
  n_layers: 12            # 堆叠的 Mamba 模块数量

# --- 特征提取器算法设置 (Feature Extractor Algorithm Settings) ---
feature_extractor:
  # PFD 特征提取参数 (暂时禁用，保留配置)
  pfd_time_window: 25000      # Time window for Mf calculation (25ms in µs)
  pfd_neighborhood_size: 3    # Neighborhood size for PFD features (3x3)

# --- 训练设置 (Training Settings) ---
training:
  epochs: 10
  learning_rate: 0.0005                         # 大模型使用较小学习率
  checkpoint_dir: "./checkpoints"
  
  # TBPTT (Truncated Backpropagation Through Time) 参数
  chunk_size: 8192                              # TBPTT截断长度 (根据显存调整)
  
  # 每个epoch的长序列数量
  num_long_sequences_per_epoch: 150              # generate用序列数
  
  # 验证和保存频率 (基于步数)
  validate_every_n_steps: 1000                  # 每1000个chunks验证一次
  save_every_n_steps: 2000                      # 每2000个chunks保存一次

# --- 评估设置 (Evaluation Settings) ---
evaluation:
  checkpoint_path: "./checkpoints/best_model.pth"
  num_long_sequences_per_epoch: 5               # 评估用序列数