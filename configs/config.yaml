# ===================================================================
#      Configuration File for EventMamba-FX (Optimized Structure)
# ===================================================================

# --- 运行设置 (Run Settings) ---
run:
  mode: train         # 运行模式: 'train' or 'evaluate'
  experiment_name: event_denoising_mamba_v1
  
# --- 数据集设置 (Data Settings) ---
data:
  # DSEC数据集路径 (使用内存高效版本)
  dsec_path: "/mnt/e/2025/event_flick_flare/object_detection/dsec-det-master/data/train"
  
  # Flare7Kpp数据集路径 (Compound_Flare散射数据)
  flare7k_path: "/mnt/e/2025/physical_deflare/Datasets/Flare7Kpp/Flare7Kpp"
  
  # 随机化训练数据生成策略 (提高泛化能力)
  randomized_training:
    # 背景事件随机长度范围 (避免过长导致内存压力)
    background_duration_range: [0.3, 1.2]   # 0.3-1.2秒 (适中范围)
    # 炫光事件随机长度范围 (避免仿真器压力过大)  
    flare_duration_range: [0.2, 0.8]        # 0.2-0.8秒 (控制帧数)
    
    # 双向随机偏移范围 (两者都可以有时间偏移)
    background_offset_range: [0.0, 0.3]     # 背景事件偏移0-0.3秒
    flare_offset_range: [0.0, 0.5]          # 炫光事件偏移0-0.5秒
    
    # 训练集偏向设置 (保持常见场景为主)
    background_contains_flare_prob: 0.75    # 75%情况下背景包含炫光
    flare_only_prob: 0.1                    # 10%只有炫光事件
    background_only_prob: 0.15              # 15%只有背景事件
    
    # 最终输入长度随机化 (给Mamba的输入)
    final_duration_range: [0.4, 1.5]        # 最终序列0.4-1.5秒
    
    # 安全限制 (防止内存/计算压力)
    max_total_duration: 2.0                 # 绝对最大时长2秒
    max_flare_frames: 400                    # 炫光最大帧数限制
    
  # 合成flare事件的参数 (基于真实人造光源闪烁频率)  
  flare_synthesis:
    # 真实世界人造光源闪烁频率 (基于电网频率)
    realistic_frequencies:
      # 50Hz电网国家 (欧洲/亚洲/非洲/澳洲): 荧光灯、LED闪烁100Hz
      power_50hz: 100.0                  # 基础频率100Hz
      # 60Hz电网国家 (北美/部分南美): 荧光灯、LED闪烁120Hz  
      power_60hz: 120.0                  # 基础频率120Hz
      # 日本特殊情况: 东部50Hz, 西部60Hz
      japan_east: 100.0                  # 东京等地区
      japan_west: 120.0                  # 大阪等地区
    
    # 随机变化范围 (±Hz, 模拟电网不稳定、调光器、老化等因素)
    frequency_variation: 5.0             # ±5Hz随机变化
    
    # 动态帧率计算 (基于频率自动调整, 已优化)
    min_samples_per_cycle: 6             # 每个闪烁周期最少采样点数 (降低)
    max_fps: 400                         # 最大帧率限制 (进一步降低)
    
    flicker_curves: ["sine", "square", "triangle", "exponential"]  # 闪烁曲线类型
    position_random: true                # 随机flare位置
    intensity_scale: [0.5, 2.0]        # 强度缩放范围
  
  # 向后兼容参数 (保持原有接口)
  time_window_us: 1000000   # 1 second (基础参数，会被随机化覆盖)
  
  # 事件相机分辨率 (DSEC分辨率)
  resolution_h: 480
  resolution_w: 640

  # DataLoader 参数 
  sequence_length: 8     # 超小序列长度进行快速验证
  num_workers: 0          # 加载数据的进程数 (set to 0 for debugging)

# --- 模型架构设置 (Model Architecture Settings) ---
model:
  # 特征提取器输出的维度，同时也是Mamba嵌入层之前的输入维度 (优化为11维，移除最后2个全局特征)
  input_feature_dim: 11     
  
  # Mamba 骨干网络参数 - 可根据显卡性能调整
  d_model: 128            # Mamba 内部的工作维度 (可调整: 64/128/256/512)
  d_state: 16             # SSM 状态空间的维度 (可调整: 8/16/32/64)
  d_conv: 4               # Mamba 内部1D卷积核大小 (可调整: 3/4/5)
  expand: 2               # Mamba 块的扩展因子 (可调整: 1/2/4)
  n_layers: 4             # 堆叠的 Mamba 模块数量 (可调整: 2/4/6/8/12)
  
  # 更强显卡建议配置 (注释掉的高性能版本):
  # d_model: 512           # 4倍容量
  # d_state: 64            # 4倍状态空间  
  # n_layers: 8            # 2倍深度
  # expand: 4              # 2倍扩展

# --- 特征提取器算法设置 (Feature Extractor Algorithm Settings) ---
feature_extractor:
  # PFD 特征提取参数
  pfd_time_window: 25000      # Time window for Mf calculation (25ms in µs)
  pfd_neighborhood_size: 3    # Neighborhood size for PFD features (1=1x1, 3=3x3, 5=5x5)
  
  # 原有参数 (保持向后兼容)
  coarse_time_window: 2000    # (δtc, in µs)
  coarse_support_threshold: 1 # (μ)
  coarse_neighborhood_size: 3 # (n x n)
  fine_time_window: 30000     # (δtf, in µs)
  fine_neighborhood_size: 3   # (n x n)

# --- 训练设置 (Training Settings) ---
training:
  epochs: 1  # 验证用，只训练1轮
  batch_size: 2  # 更小的batch size进行快速验证
  learning_rate: 0.001
  checkpoint_dir: "./checkpoints" # 保存模型权重的目录

# --- 评估设置 (Evaluation Settings) ---
evaluation:
  batch_size: 2  # 与训练保持一致，避免内存问题
  checkpoint_path: "./checkpoints/best_model.pth" # 评估时加载的模型路径