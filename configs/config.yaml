# ===================================================================
#      Configuration File for EventMamba-FX (TBPTT Architecture)
# ===================================================================
#
# ğŸ¯ TBPTT (Truncated Backpropagation Through Time) Architecture:
#
# æ–°æ¶æ„æ¦‚å¿µè¯´æ˜ï¼š
# - DataLoader: "é•¿åºåˆ—å·¥å‚" - æ¯æ¬¡è¿”å›ä¸€ä¸ªå®Œæ•´çš„é•¿ç‰¹å¾åºåˆ—
# - Trainer: "åºåˆ—æ¶ˆåŒ–å™¨" - åœ¨é•¿åºåˆ—ä¸Šè¿›è¡ŒTBPTT chunkåˆ‡åˆ†è®­ç»ƒ
# 
# å·¥ä½œæµç¨‹ï¼š
# 1. DataLoaderç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„é•¿åºåˆ— [L, feature_dim]
# 2. Trainerå°†å…¶åˆ‡åˆ†ä¸ºå›ºå®šå¤§å°çš„chunks [chunk_size, feature_dim]
# 3. æ¯ä¸ªchunkç‹¬ç«‹è¿›è¡Œå‰å‘+åå‘ä¼ æ’­ï¼ˆæ¢¯åº¦è¢«æˆªæ–­ï¼‰
# 4. æ¨¡å‹çŠ¶æ€åœ¨æ¯ä¸ªchunkè¾¹ç•Œé‡ç½®ï¼Œä½†é€šè¿‡è¿ç»­æ•°æ®å­¦ä¹ è·¨è¾¹ç•Œæ¨¡å¼
#
# ä¼˜åŠ¿ï¼š
# - é€‚åˆè¶…é•¿åºåˆ—è®­ç»ƒï¼ˆæ•°ä¸‡ä¸ªäº‹ä»¶ï¼‰
# - å†…å­˜å‹å¥½ï¼šæ¯æ¬¡åªå¤„ç†ä¸€ä¸ªchunk
# - æ¢¯åº¦ç¨³å®šï¼šæˆªæ–­é¿å…æ¢¯åº¦æ¶ˆå¤±/çˆ†ç‚¸
# ==================================================================

# --- è¿è¡Œè®¾ç½® (Run Settings) ---
run:
  mode: two_step_generation    # æ–°æ¨¡å¼: 'two_step_generation' 
  experiment_name: event_denoising_mamba_v2_decoupled

# --- ä¸¤æ­¥ç”Ÿæˆç®¡çº¿è®¾ç½® (Two-Step Generation Pipeline) ---
generation:
  # Step 1: ç‚«å…‰äº‹ä»¶ç”Ÿæˆæ•°é‡
  num_train_sequences: 10      # è®­ç»ƒç”¨ç‚«å…‰åºåˆ—æ•°
  num_val_sequences: 5         # éªŒè¯ç”¨ç‚«å…‰åºåˆ—æ•°
  num_test_sequences: 0        # æµ‹è¯•ç”¨ç‚«å…‰åºåˆ—æ•° (å¯é€‰)
  
  # Debugæ¨¡å¼å‚æ•°
  debug_sequences: 3           # debugæ¨¡å¼ä¸‹çš„åºåˆ—æ•°é‡
  debug_subdivisions: [0.5, 1, 2, 4]  # debugå¯è§†åŒ–çš„æ—¶é—´åˆ†è¾¨ç‡
  
  # è¾“å‡ºè·¯å¾„é…ç½®
  output_paths:
    flare_events: "output/data/flare_events"     # Step 1è¾“å‡ºï¼šçº¯ç‚«å…‰äº‹ä»¶
    bg_events: "output/data/bg_events"           # Step 2è¾“å‡ºï¼šèƒŒæ™¯äº‹ä»¶
    merge_events: "output/data/merge_events"     # Step 2è¾“å‡ºï¼šåˆå¹¶äº‹ä»¶
    debug_output: "output/debug"                 # Debugå¯è§†åŒ–è¾“å‡º
  
# --- æ•°æ®é›†è®¾ç½® (Data Settings) ---
data:
  # èƒŒæ™¯äº‹ä»¶æ•°æ®è·¯å¾„ (ç®€åŒ–çš„H5æ–‡ä»¶ç›®å½•)
  dsec_path: "data/bg_events"
  
  # Flare7Kppæ•°æ®é›†è·¯å¾„ (Compound_Flareæ•£å°„æ•°æ®)
  # Flare7K/Scattering_Flare/Scattering_Flare and  Flare-R/Compound_Flare
  flare7k_path: "/mnt/e/2025/physical_deflare/Datasets/Flare7Kpp/Flare7Kpp"
  
  # äº‹ä»¶ä»¿çœŸå™¨é€‰æ‹© (Event Simulator Selection)
  event_simulator:
    type: "dvs_voltmeter"           # é€‰æ‹©ä»¿çœŸå™¨: "dvs_voltmeter", "v2ce", or "iebcs" 
    
    # DVS-Voltmeter é…ç½® (ä¼ ç»Ÿä»¿çœŸå™¨)
    dvs_voltmeter:
      simulator_path: "/mnt/e/2025/event_flick_flare/main/simulator/DVS-Voltmeter-main"
      timeout_sec: 60
      
      # DVSå‚æ•°è°ƒä¼˜ (åŸºäºç‰©ç†åŸç†å‡å°‘äº‹ä»¶æ•°é‡)
      parameters:
        # DVS346å‚æ•° [k1, k2, k3, k4, k5, k6] - åŸºäºBrownian Motion with Driftæ¨¡å‹
        # è®ºæ–‡Eq.(10): Î”Vd = (k1/(L+k2))Â·kdLÂ·Î”t + (k3/(L+k2))Â·âˆšLÂ·W(Î”t) + k4Â·Î”t + k5Â·LÂ·Î”t + k6Â·W(Î”t)
        # 
        # ç‰©ç†æ„ä¹‰:
        # k1: å…‰-ç”µè½¬æ¢ç³»æ•° (è¶Šå°->å¯¹å…‰å˜åŒ–æ•æ„Ÿåº¦è¶Šä½->äº‹ä»¶è¶Šå°‘)
        # k2: æš—ç”µæµåç§» (è¶Šå¤§->åˆ†æ¯è¶Šå¤§->æ•æ„Ÿåº¦è¶Šä½->äº‹ä»¶è¶Šå°‘) 
        # k3: å…‰å­å™ªå£°ç³»æ•° (è¶Šå°->éšæœºè§¦å‘è¶Šå°‘->äº‹ä»¶è¶Šå°‘)
        # k4: æ¸©åº¦æ¼ç”µæµ (å½±å“èƒŒæ™¯äº‹ä»¶ç‡)
        # k5: å¯„ç”Ÿå…‰ç”µæµ (è¶Šå°->äº®åº¦ç›¸å…³å™ªå£°è¶Šå°‘->äº‹ä»¶è¶Šå°‘)
        # k6: æ¼ç”µæµå™ªå£° (è¶Šå°->éšæœºå™ªå£°è¶Šå°‘->äº‹ä»¶è¶Šå°‘)
        #
        # è°ƒä½k1å‚æ•°å‡å°‘ç‚«å…‰äº‹ä»¶å¼ºåº¦ (ä»5.265è°ƒä½åˆ°2.5)
        dvs346_k: [2.5, 20, 0.0001, 1e-7, 5e-9, 0.00001]  # é™ä½k1å…‰-ç”µè½¬æ¢æ•æ„Ÿåº¦
        
        # DVS240å‚æ•° (GitHubåŸå§‹)
        dvs240_k: [4.424, 23, 0.0002, 1e-7, 5e-8, 0.00001]  # 0.000094 * 47065 = 4.424
      
    # V2CE é…ç½® (æ–°çš„æ·±åº¦å­¦ä¹ ä»¿çœŸå™¨)  
    v2ce:
      model_path: "/mnt/e/2025/event_flick_flare/main/simulator/V2CE-Toolbox-master/weights/v2ce_3d.pt"
      toolbox_path: "/mnt/e/2025/event_flick_flare/main/simulator/V2CE-Toolbox-master"
      seq_len: 16                   # V2CEåºåˆ—é•¿åº¦ (æ›´çŸ­ï¼Œæ•ˆç‡æ›´é«˜)
      infer_type: "center"          # "center" or "pano"
      batch_size: 1                 # V2CEæ‰¹å¤„ç†å¤§å° 
      height: 260                   # V2CEæ ‡å‡†é«˜åº¦
      width: 346                    # V2CEæ ‡å‡†å®½åº¦
      
      # åŠ¨æ€å¸§ç‡é…ç½® (æ ¹æ®ç‚«å…‰é¢‘ç‡å’Œæ—¶é•¿è‡ªé€‚åº”)
      base_fps: 200                 # åŸºç¡€å¸§ç‡ (æœ€ä½200fps)
      max_fps: 1600                 # æœ€å¤§å¸§ç‡é™åˆ¶ (åŒ¹é…flare_synthesis)
      min_samples_per_cycle: 8      # æ¯ä¸ªé—ªçƒå‘¨æœŸæœ€å°‘é‡‡æ ·æ•°
      fps_scale_factor: 1.5         # å¸§ç‡ç¼©æ”¾å› å­
      
      ceil: 10                      # äº‹ä»¶å¸§ä¸Šé™å€¼
      upper_bound_percentile: 98    # äº‹ä»¶å¸§ä¸Šç•Œç™¾åˆ†ä½
    
    # IEBCS é…ç½® (ICNS Event Based Camera Simulator)
    iebcs:
      simulator_path: "/mnt/e/2025/event_flick_flare/main/simulator/IEBCS-main"
      timeout_sec: 60
      
      # IEBCSä¼ æ„Ÿå™¨å‚æ•° (åŸºäºDVS346è§„æ ¼)
      sensor_parameters:
        th_pos: 0.4                # ONé˜ˆå€¼ (å¯¹æ•°åŸŸ)
        th_neg: 0.4                # OFFé˜ˆå€¼ (å¯¹æ•°åŸŸ)  
        th_noise: 0.01             # é˜ˆå€¼å™ªå£°æ ‡å‡†å·®
        latency: 100               # å»¶è¿Ÿ (å¾®ç§’)
        tau: 40                    # å‰ç«¯æ—¶é—´å¸¸æ•° (å¾®ç§’)
        jitter: 10                 # æ—¶é—´æŠ–åŠ¨æ ‡å‡†å·® (å¾®ç§’)
        bgnp: 0.1                  # ONäº‹ä»¶å™ªå£°ç‡ (events/pixel/s)
        bgnn: 0.01                 # OFFäº‹ä»¶å™ªå£°ç‡ (events/pixel/s)
        refractory: 100            # ä¸åº”æœŸ (å¾®ç§’)
        dt: 500                    # å¸§é—´æ—¶é—´é—´éš” (å¾®ç§’) - å‡åŠæé«˜é¢‘é—ªé‡‡æ ·
        
      # åŠ¨æ€å¸§ç‡è®¡ç®— (ç¡®ä¿é¢‘é—ªè´¨é‡)
      frame_generation:
        min_samples_per_cycle: 12  # æ¯ä¸ªé—ªçƒå‘¨æœŸæœ€å°‘é‡‡æ ·ç‚¹æ•° (ä¸å…¶ä»–ä»¿çœŸå™¨ä¸€è‡´)
        max_fps: 600               # æœ€å¤§å¸§ç‡é™åˆ¶ (æé«˜ä»¥åæ˜ é¢‘é—ª)
        base_fps: 300              # åŸºç¡€å¸§ç‡
        
      # å¤šæ—¶é—´çª—å£äº‹ä»¶å¯è§†åŒ– (ä¸DVSä¸€è‡´)
      debug_visualization:
        enable_multi_timewindow: true    # å¯ç”¨å¤šæ—¶é—´çª—å£å¯è§†åŒ– (ä»…åœ¨debugæ¨¡å¼ä¸‹)
        time_window_scales: [0.5, 1, 2, 4] # æ—¶é—´çª—å£å€æ•° (äº‹ä»¶ç§¯ç´¯æ—¶é•¿)
        temporal_subdivisions: 5          # æ¯å¸§æ—¶é—´ç»†åˆ†æ•° (ä¸DVSä¸€è‡´)
        
      # å™ªå£°æ¨¡å‹é…ç½® (å¯é€‰)
      noise_model:
        enable_measured_noise: false  # æ˜¯å¦ä½¿ç”¨æµ‹é‡çš„å™ªå£°åˆ†å¸ƒ
        noise_pos_file: "data/noise_pos_161lux.npy"
        noise_neg_file: "data/noise_neg_161lux.npy"
  
  # éšæœºåŒ–è®­ç»ƒæ•°æ®ç”Ÿæˆç­–ç•¥
  randomized_training:
    # èƒŒæ™¯äº‹ä»¶éšæœºé•¿åº¦èŒƒå›´ (ç¼©å‡ç”¨äºå¿«é€Ÿæµ‹è¯•)
    background_duration_range: [0.05, 0.1]      # 50-100ms (ç¼©å‡ç”¨äºå¿«é€Ÿdebugæµ‹è¯•)
    
    # ğŸš¨ REMOVED: flare_duration_range - ç”±flare_synthesis.duration_secæ§åˆ¶
    # ğŸš¨ REMOVED: flareç›¸å…³offset - ç‚«å…‰ç”Ÿæˆå®Œå…¨ç”±flare_synthesisç®¡ç†
    
    # è®­ç»ƒé›†åå‘è®¾ç½® (ä¿æŒå¸¸è§åœºæ™¯ä¸ºä¸»)
    background_contains_flare_prob: 0.75    # 75%æƒ…å†µä¸‹èƒŒæ™¯åŒ…å«ç‚«å…‰
    flare_only_prob: 0.1                    # 10%åªæœ‰ç‚«å…‰äº‹ä»¶
    background_only_prob: 0.15              # 15%åªæœ‰èƒŒæ™¯äº‹ä»¶
    
  # åˆæˆflareäº‹ä»¶çš„å‚æ•° (åŸºäºçœŸå®äººé€ å…‰æºé—ªçƒé¢‘ç‡)  
  flare_synthesis:
    # çœŸå®ä¸–ç•Œäººé€ å…‰æºé—ªçƒé¢‘ç‡ (åŸºäºç”µç½‘é¢‘ç‡)
    realistic_frequencies:
      # 50Hzç”µç½‘å›½å®¶ (æ¬§æ´²/äºšæ´²/éæ´²/æ¾³æ´²): è§å…‰ç¯ã€LEDé—ªçƒ100Hz
      power_50hz: 100.0                  # åŸºç¡€é¢‘ç‡100Hz
      # 60Hzç”µç½‘å›½å®¶ (åŒ—ç¾/éƒ¨åˆ†å—ç¾): è§å…‰ç¯ã€LEDé—ªçƒ120Hz  
      power_60hz: 120.0                  # åŸºç¡€é¢‘ç‡120Hz
      # æ—¥æœ¬ç‰¹æ®Šæƒ…å†µ: ä¸œéƒ¨50Hz, è¥¿éƒ¨60Hz
      japan_east: 100.0                  # ä¸œäº¬ç­‰åœ°åŒº
      japan_west: 120.0                  # å¤§é˜ªç­‰åœ°åŒº
    
    # éšæœºå˜åŒ–èŒƒå›´ (Â±Hz, æ¨¡æ‹Ÿç”µç½‘ä¸ç¨³å®šã€è°ƒå…‰å™¨ã€è€åŒ–ç­‰å› ç´ )
    frequency_variation: 5.0             # Â±5Hzéšæœºå˜åŒ–
    
    # åŠ¨æ€å¸§ç‡è®¡ç®— (æé«˜å¸§å¯†åº¦ç¡®ä¿å……åˆ†é‡‡æ ·)
    min_samples_per_cycle: 48            # æ¯ä¸ªé—ªçƒå‘¨æœŸæœ€å°‘é‡‡æ ·ç‚¹æ•° (å†æ¬¡ç¿»å€ï¼š1sä»2400â†’4800å¸§)
    max_fps: 6000                        # æœ€å¤§å¸§ç‡é™åˆ¶ (ç¿»å€æ”¯æŒæ›´é«˜å¯†åº¦é‡‡æ ·)
    
    flicker_curves: ["sine", "square", "triangle", "exponential"]  # é—ªçƒæ›²çº¿ç±»å‹
    position_random: true                # éšæœºflareä½ç½®
    intensity_scale: [0.8, 1.2]        # å¼ºåº¦ç¼©æ”¾èŒƒå›´ (å‡å°éšæœºæ€§ï¼Œé¿å…ç ´åé¢‘é—ªè§„å¾‹)
    
    # ğŸš¨ UNIFIED CONTROL: ç‚«å…‰æŒç»­æ—¶é—´çš„å”¯ä¸€æ§åˆ¶å‚æ•° (ç¼©å‡ç”¨äºå¿«é€Ÿæµ‹è¯•)
    duration_range: [0.03, 0.08]       # ç‚«å…‰åºåˆ—æ—¶é•¿èŒƒå›´ 30-80ms (ç¼©å‡ç”¨äºå¿«é€Ÿdebugæµ‹è¯•)
    
    # çœŸå®äººé€ å…‰æºå¼ºåº¦èŒƒå›´ (é¿å…å®Œå…¨é»‘å±)
    min_intensity_baseline: [0.0, 0.7]  # æœ€ä½å¼ºåº¦éšæœºèŒƒå›´ (0-70%)
    max_intensity: 1.0                  # æœ€å¤§å¼ºåº¦ (100%)
  
  # å‘åå…¼å®¹å‚æ•° (ä¿æŒåŸæœ‰æ¥å£)
  time_window_us: 1000000   # 1 second (åŸºç¡€å‚æ•°ï¼Œä¼šè¢«éšæœºåŒ–è¦†ç›–)
  
  # äº‹ä»¶ç›¸æœºåˆ†è¾¨ç‡ (DSECåˆ†è¾¨ç‡)
  resolution_h: 480
  resolution_w: 640

  # DataLoader å‚æ•° 
  sequence_length: 64     # åˆç†çš„åºåˆ—é•¿åº¦è¿›è¡Œæœ‰æ•ˆè®­ç»ƒï¼ˆ4å¤ªå°äº†ï¼ï¼‰
  num_workers: 0          # åŠ è½½æ•°æ®çš„è¿›ç¨‹æ•° (set to 0 for debugging)
  max_samples_debug: 4   # Debugæ¨¡å¼ï¼šåªä½¿ç”¨4ä¸ªæ ·æœ¬ï¼ˆ2ä¸ªbatchå¿«é€ŸéªŒè¯ï¼‰

# --- æ¨¡å‹æ¶æ„è®¾ç½® (Model Architecture Settings) ---
model:
  # ç‰¹å¾æå–å™¨è¾“å‡ºçš„ç»´åº¦ï¼ŒåŒæ—¶ä¹Ÿæ˜¯MambaåµŒå…¥å±‚ä¹‹å‰çš„è¾“å…¥ç»´åº¦ (ä¸´æ—¶æ”¹ä¸º4ç»´ï¼ŒPFDå·²ç¦ç”¨)
  input_feature_dim: 4     
  
  # Mamba éª¨å¹²ç½‘ç»œå‚æ•° - å¯æ ¹æ®æ˜¾å¡æ€§èƒ½è°ƒæ•´
  # d_model: 128            # Mamba å†…éƒ¨çš„å·¥ä½œç»´åº¦ (å¯è°ƒæ•´: 64/128/256/512)
  # d_state: 16             # SSM çŠ¶æ€ç©ºé—´çš„ç»´åº¦ (å¯è°ƒæ•´: 8/16/32/64)
  # d_conv: 4               # Mamba å†…éƒ¨1Då·ç§¯æ ¸å¤§å° (å¯è°ƒæ•´: 3/4/5)
  # expand: 2               # Mamba å—çš„æ‰©å±•å› å­ (å¯è°ƒæ•´: 1/2/4)
  # n_layers: 4             # å †å çš„ Mamba æ¨¡å—æ•°é‡ (å¯è°ƒæ•´: 2/4/6/8/12)
  
  # æ›´å¼ºæ˜¾å¡å»ºè®®é…ç½® (æ³¨é‡Šæ‰çš„é«˜æ€§èƒ½ç‰ˆæœ¬):
  d_model: 512            # Mamba å†…éƒ¨çš„å·¥ä½œç»´åº¦ (å¯è°ƒæ•´: 64/128/256/512)
  d_state: 64             # SSM çŠ¶æ€ç©ºé—´çš„ç»´åº¦ (å¯è°ƒæ•´: 8/16/32/64)
  d_conv: 5               # Mamba å†…éƒ¨1Då·ç§¯æ ¸å¤§å° (å¯è°ƒæ•´: 3/4/5)
  expand: 4               # Mamba å—çš„æ‰©å±•å› å­ (å¯è°ƒæ•´: 1/2/4)
  n_layers: 12             # å †å çš„ Mamba æ¨¡å—æ•°é‡ (å¯è°ƒæ•´: 2/4/6/8/12)

# --- ç‰¹å¾æå–å™¨ç®—æ³•è®¾ç½® (Feature Extractor Algorithm Settings) ---
feature_extractor:
  # PFD ç‰¹å¾æå–å‚æ•°
  pfd_time_window: 25000      # Time window for Mf calculation (25ms in Âµs)
  pfd_neighborhood_size: 3    # Neighborhood size for PFD features (1=1x1, 3=3x3, 5=5x5)
  
  # åŸæœ‰å‚æ•° (ä¿æŒå‘åå…¼å®¹)
  coarse_time_window: 2000    # (Î´tc, in Âµs)
  coarse_support_threshold: 1 # (Î¼)
  coarse_neighborhood_size: 3 # (n x n)
  fine_time_window: 30000     # (Î´tf, in Âµs)
  fine_neighborhood_size: 3   # (n x n)

# --- è®­ç»ƒè®¾ç½® (Training Settings) ---
training:
  epochs: 1  # éªŒè¯ç”¨ï¼Œåªè®­ç»ƒ1è½®
  learning_rate: 0.0005
  checkpoint_dir: "./checkpoints" # ä¿å­˜æ¨¡å‹æƒé‡çš„ç›®å½•
  
  # âœ… TBPTT (Truncated Backpropagation Through Time) å‚æ•°
  chunk_size: 8192                          # TBPTTæˆªæ–­é•¿åº¦ (å–ä»£æ—§çš„batch_sizeåœ¨è®­ç»ƒä¸­çš„ä½œç”¨)
  
  # 'generate'æ¨¡å¼ä¸‹, å®šä¹‰æ¯ä¸ªepochçš„"é•¿åº¦" (å°å‹æµ‹è¯•ç”¨)
  num_long_sequences_per_epoch: 1          # ğŸš¨ SMALL TEST: åªç”Ÿæˆ1ä¸ªåºåˆ—ç”¨äºéªŒè¯
  
  # æ–­ç‚¹ç»­è®­çš„æ ¸å¿ƒå‚æ•° 
  validate_every_n_steps: 5000              
  save_every_n_steps: 5000                  

# --- è¯„ä¼°è®¾ç½® (Evaluation Settings) ---
evaluation:
  checkpoint_path: "./checkpoints/best_model.pth" # è¯„ä¼°æ—¶åŠ è½½çš„æ¨¡å‹è·¯å¾„
  
  # TBPTT éªŒè¯å‚æ•°  
  num_long_sequences_per_epoch: 50          # ğŸš¨ ç”Ÿæˆ5ä¸ªéªŒè¯åºåˆ—